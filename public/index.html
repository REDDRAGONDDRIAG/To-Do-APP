<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>To-Do Application with Gamification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <link rel="stylesheet" href="styles.css">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body class="dark-theme">
  <div class="container dark-theme">
    <h1>To-Do Application</h1>

    <!-- Gamification UI -->
    <div id="scoreboard">Score: <span id="score">0</span></div>
    <div id="xp-bar-container">
      <div id="xp-bar"></div>
    </div>
    <div id="level-display">Level: <span id="level">1</span></div>

    <!-- Google Auth -->
    <button id="signin-btn" onclick="signIn()">Sign In</button>
    <div id="g-signin-info" style="display: none; margin-bottom: 15px;">
      <span id="user-name"></span>
      <button onclick="signOut()">Sign Out</button>
    </div>

    <!-- Task Input -->
    <input type="text" id="taskInput" placeholder="Enter your task">
    <select id="prioritySelect">
      <option value="p1">P1 (Highest)</option>
      <option value="p2">P2</option>
      <option value="p3" selected>P3</option>
      <option value="p4">P4</option>
      <option value="p5">P5 (Lowest)</option>
    </select>
    <input type="date" id="taskDate">
    <button onclick="addTaskBack(); addTaskFront();">Add Task</button>

    <!-- Task List -->
    <ul id="taskList"></ul>

    <!-- Theme Switch -->
    <button id="theme-toggle" onclick="changeTheme()">Change Theme</button>

    <!-- Calendar Status -->
    <div id="calendar-status" style="margin-top: 15px; font-size: 0.9em;"></div>
  </div>

  <!-- Notification Modal -->
  <div id="notificationModal" class="modal">
    <div class="modal-content">
      <h2>Powiadomienia</h2>
      <p>Czy chcesz otrzymywać powiadomienia z naszej aplikacji?</p>
      <button id="allowNotificationsBtn">Zezwól</button>
      <button id="denyNotificationsBtn">Nie teraz</button>
    </div>
  </div>

  <!-- JS Modules & Logic -->
  <script src="changeTheme.js"></script>
  <script type="module" src="Config.js"></script>
  <script type="module" src="GoogleCalendar.js"></script>
  <script type="module" src="FrontEndTaskManage.js"></script>
  <script type="module" src="BackEndTaskManage.js"></script>

  <script>
    // Sign out
    async function signOut() {
      const { auth } = await import('./Config.js');
      await auth.signOut();
      document.getElementById('g-signin-info').style.display = 'none';
      document.getElementById('signin-btn').style.display = 'block';
      document.getElementById('taskList').innerHTML = '';
    }

    // Update UI when signed in
    function updateAuthUI(user) {
      const info = document.getElementById('g-signin-info');
      const btn  = document.getElementById('signin-btn');
      if (user) {
        document.getElementById('user-name').textContent = `Welcome, ${user.displayName}`;
        info.style.display = 'block';
        btn.style.display = 'none';
      } else {
        info.style.display = 'none';
        btn.style.display = 'block';
      }
    }

    // Auth state observer
    (async () => {
      const { auth } = await import('./Config.js');
      auth.onAuthStateChanged(updateAuthUI);
    })();

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(r => console.log("SW registered", r))
        .catch(e => console.error("SW error", e));
    }
  </script>
</body>
</html>
